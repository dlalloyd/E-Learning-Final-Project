// Prisma Schema — Adaptive E-Learning System
// Updated: IRT 3PL + BKT architecture (ADR-001, ADR-003, ADR-004)
// Replaces Elo-based difficulty field with IRT parameters (a, b, c)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
    url      = env("DATABASE_URL")
}

// ─── User ─────────────────────────────────────────────────────────────────────

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      String   @default("learner") // learner, instructor, admin
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions    Session[]8
  assessments Assessment[]
  progress    UserProgress[]
  badges      UserBadge[]
}

// ─── Topic / Lesson / Quiz ────────────────────────────────────────────────────

model Topic {
  id          String  @id @default(cuid())
  title       String
  description String?
  order       Int
  createdAt   DateTime @default(now())

  lessons       Lesson[]
  prerequisites TopicPrerequisite[] @relation("topic_prereqs")
  requiredFor   TopicPrerequisite[] @relation("topic_required_for")
}

model TopicPrerequisite {
  topicId        String
  prerequisiteId String
  topic        Topic @relation("topic_required_for", fields: [topicId], references: [id], onDelete: Cascade)
  prerequisite Topic @relation("topic_prereqs", fields: [prerequisiteId], references: [id], onDelete: Cascade)

  @@id([topicId, prerequisiteId])
}

model Lesson {
  id        String   @id @default(cuid())
  title     String
  content   String
  topicId   String
  order     Int
  createdAt DateTime @default(now())

  topic   Topic  @relation(fields: [topicId], references: [id], onDelete: Cascade)
  quizzes Quiz[]
}

model Quiz {
  id        String   @id @default(cuid())
  title     String
  lessonId  String
  createdAt DateTime @default(now())

  lesson      Lesson       @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions   Question[]
  assessments Assessment[]
  sessions    Session[]
}

// ─── Question (IRT 3PL parameters) ───────────────────────────────────────────

model Question {
  id        String   @id @default(cuid())
  text      String
  type      String   @default("multiple_choice")
  quizId    String
  order     Int
  createdAt DateTime @default(now())

  // IRT 3PL parameters (replaces Elo difficulty field)
  // a = discrimination (0.5–2.0), b = difficulty (logits), c = guessing (fixed 0.25)
  irt_a     Float    @default(1.0)  // discrimination
  irt_b     Float    @default(0.0)  // difficulty in logits
  irt_c     Float    @default(0.25) // guessing (fixed for 4-option MCQ)

  // Bloom's taxonomy level and knowledge component
  bloom     Int      @default(1)    // 1=Remembering, 2=Understanding, 3=Applying
  kc        String   @default("")   // knowledge component ID (matches BKT params)

  quiz         Quiz          @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options      Option[]
  answers      Answer[]
  interactions Interaction[]
}

model Option {
  id         String  @id @default(cuid())
  text       String
  isCorrect  Boolean @default(false)
  questionId String
  order      Int

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

// ─── Session (per learner per study condition) ────────────────────────────────

model Session {
  id          String    @id @default(cuid())
  userId      String
  quizId      String
  condition   String    @default("adaptive") // "adaptive" | "static"
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  // IRT learner state — updated after each response via EAP
  theta       Float     @default(-0.780) // current ability estimate (self-pilot θ₀)
  thetaSd     Float     @default(0.543)  // posterior standard deviation

  // BKT state stored as JSON — Record<kcId, KCState>
  kcStates    String    @default("{}") // JSON serialised

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz  Quiz  @relation(fields: [quizId], references: [id], onDelete: Cascade)

  interactions Interaction[]
  assessments  Assessment[]
}

// ─── Interaction (single Q&A event) ──────────────────────────────────────────

model Interaction {
  id             String   @id @default(cuid())
  sessionId      String
  questionId     String
  selectedAnswer String   // option label: "A", "B", "C", or "D"
  isCorrect      Boolean
  responseTimeMs Int      // milliseconds

  // IRT state before and after this response
  theta_before   Float
  theta_after    Float

  // BKT state for the question's KC before and after
  pLearned_before Float
  pLearned_after  Float

  createdAt DateTime @default(now())

  session  Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

// ─── Assessment (pre/post/delayed test) ──────────────────────────────────────

model Assessment {
  id          String    @id @default(cuid())
  userId      String
  sessionId   String?
  quizId      String
  type        String    @default("post_test") // pre_test | post_test | delayed_post_test
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  score       Float?    // raw score (correct / total)
  maxScore    Float?
  passed      Boolean   @default(false)
  thetaAtTime Float?    // IRT ability estimate at time of assessment

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz    Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  session Session? @relation(fields: [sessionId], references: [id])
  answers Answer[]
}

model Answer {
  id               String   @id @default(cuid())
  assessmentId     String
  questionId       String
  selectedOptionId String?
  textAnswer       String?
  isCorrect        Boolean?
  createdAt        DateTime @default(now())

  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  question   Question   @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

// ─── Progress / Badges ────────────────────────────────────────────────────────

model UserProgress {
  id        String   @id @default(cuid())
  userId    String
  topicId   String
  accuracy  Float    @default(0)
  completed Boolean  @default(false)
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, topicId])
}

model Badge {
  id          String   @id @default(cuid())
  name        String
  description String?
  icon        String?
  criteria    String
  createdAt   DateTime @default(now())

  users UserBadge[]
}

model UserBadge {
  id       String   @id @default(cuid())
  userId   String
  badgeId  String
  earnedAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
}

model SystemLog {
  id        String   @id @default(cuid())
  action    String
  userId    String?
  details   String?
  timestamp DateTime @default(now())
}
